<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…«å­—å‘½ç†æŠ¥å‘Š Â· æ·±åº¦è§£æ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
      background: #eeeeee url('img/computer background LIFE.TUNE.png') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      color: #000000;
    }



    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px 0;
      border-bottom: 2px solid #FFCF68;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      font-size: 2.2rem;
      color: #FFCF68;
      text-shadow: 0 0 10px rgba(255, 207, 104, 0.5);
    }

    .title-group h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: #000000;
      margin-bottom: 4px;
    }

    .title-group p {
      color: #666666;
      font-size: 0.85rem;
    }

    .btn-container{
        max-width: 130px;
        margin: 20px auto;
        text-align: center;
    }

    .back-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #FFCF68, #E6B84D);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(49, 130, 206, 0.3);
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(142, 109, 31, 0.3);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .report-container {
      background: rgba(255, 255, 255, 0);
      backdrop-filter: blur(1px);
      border-radius: 16px;
      padding: 40px;
      margin: 20px;
      border: 1px solid rgba(255, 207, 104, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666666;
    }

    .loading-icon {
      font-size: 3rem;
      color: #FFCF68;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    .error {
      background: rgba(245, 101, 101, 0.1);
      border: 1px solid #f56565;
      color: #000000;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin: 20px 0;
    }

    .section {
      margin-bottom: 40px;
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(255, 207, 104, 0.3);
    }

    .section-icon {
      font-size: 1.5rem;
      color: #FFCF68;
      background: rgba(255, 207, 104, 0.1);
      padding: 8px;
      border-radius: 8px;
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #000000;
    }

    .chart-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 30px;
      border: 1px solid rgba(255, 207, 104, 0.2);
      margin-bottom: 30px;
    }

    .radar-chart-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      height: 400px;
      position: relative;
    }

    .radar-chart {
      max-width: 800px;
      max-height: 400px;
      width: 100%;
      height: 100%;
    }

    /* ç§»åŠ¨ç«¯æ”¾å¤§æŒ‰é’® */
    .zoom-btn {
      display: none;
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 8px 10px;
      background: linear-gradient(135deg, #FFCF68, #E6B84D);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      line-height: 1;
      box-shadow: 0 6px 18px rgba(255, 207, 104, 0.35);
    }

    /* æ¨¡æ€å±‚ç”¨äºæ”¾å¤§æŸ¥çœ‹é›·è¾¾å›¾ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-content {
      position: relative;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      width: 100%;
      max-width: 900px;
      border: 1px solid rgba(255, 207, 104, 0.35);
    }
    .modal-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      font-size: 1.4rem;
      color: #2d3748;
      cursor: pointer;
    }
    #radarChartLarge {
      width: 100%;
      height: 400px;
    }
    #tenGodsChartLarge {
      width: 100%;
      height: 400px;
    }

         .tengods-chart-container {
       display: flex;
       justify-content: center;
       align-items: center;
       margin: 20px 0;
       height: 400px;
       position: relative;
     }

         .tengods-chart {
       max-width: 800px;
       max-height: 400px;
       width: 100%;
       height: 100%;
     }

     /* åç¥å›¾è¡¨æ”¾å¤§æŒ‰é’® */
     .zoom-btn-tengods {
       display: none;
       position: absolute;
       top: 10px;
       right: 10px;
       padding: 8px 10px;
       background: linear-gradient(135deg, #FFCF68, #E6B84D);
       color: #ffffff;
       border: none;
       border-radius: 8px;
       cursor: pointer;
       font-size: 0.9rem;
       line-height: 1;
       box-shadow: 0 6px 18px rgba(255, 207, 104, 0.35);
     }

    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
    }

    .content-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid rgba(255, 207, 104, 0.2);
      transition: all 0.3s ease;
    }

    .content-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(255, 207, 104, 0.2);
      border-color: rgba(255, 207, 104, 0.4);
    }

    /* å››æŸ±æ³¡æ³¡å±•ç¤º */
    .pillars-bubbles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .pillar-bubble-card {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 207, 104, 0.25);
      border-radius: 12px;
      padding: 16px;
    }
    .pillar-bubble-title {
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 10px;
      text-align: center;
    }
    .bubble-row { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    .bubble {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.9rem;
      border: 1px solid rgba(226, 232, 240, 1);
      background: #ffffff;
      color: #2d3748;
    }
    .bubble-stem { background: linear-gradient(135deg, rgba(255,207,104,0.18), rgba(230,184,77,0.18)); border-color: rgba(255, 207, 104, 0.6); }
    .bubble-branch { background: linear-gradient(135deg, rgba(49,130,206,0.1), rgba(43,108,176,0.1)); border-color: rgba(49,130,206,0.45); }
    .bubble-hidden { background: rgba(237,137,54,0.12); border-color: rgba(237, 137, 54, 0.5); font-size: 0.85rem; }
    .bubble-tengod { background: linear-gradient(135deg, rgba(159,122,234,0.12), rgba(128,90,213,0.12)); border-color: rgba(128,90,213,0.5); font-weight: 600; font-size: 0.85rem; }

    .card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #FFCF68;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 207, 104, 0.2);
    }

    .summary-text {
      color: #000000;
      line-height: 1.7;
      font-size: 0.95rem;
    }

    .custom-list {
      list-style: none;
      padding: 0;
    }

    .custom-list li {
      padding: 8px 0;
      color: #000000;
      position: relative;
      padding-left: 20px;
      line-height: 1.6;
    }

    .custom-list li::before {
      content: 'âœ¦';
      position: absolute;
      left: 0;
      color: #3182ce;
      font-weight: bold;
    }

    .challenge-list li::before {
      content: 'âš ';
      color: #ed8936;
    }

    .career-list li::before {
      content: '~';
      color: #48bb78;
    }

    .communication-style {
      background: rgba(255, 207, 104, 0.1);
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #FFCF68;
    }

    .communication-text {
      color: #000000;
      line-height: 1.7;
      font-style: italic;
    }

    .full-width-card {
      grid-column: 1 / -1;
    }

    .fade-in {
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        background: #eeeeee url('img/phone backgroung LIFE.TUNE.png') no-repeat center center fixed;
        background-size: cover;
      }
      
      .header-content {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      

      
      .report-container {
        padding: 24px 20px;
        margin: 10px;
      }
      
      .content-grid {
        grid-template-columns: 1fr;
      }
      
      .section-header {
        flex-direction: column;
        text-align: center;
        gap: 8px;
      }

      .radar-chart-container {
        height: 300px;
      }

      .radar-chart {
        max-width: 350px;
        max-height: 350px;
      }

             .zoom-btn {
         display: inline-flex;
         align-items: center;
         gap: 6px;
         background: rgba(255, 165, 0, 0.3) !important;
         border: 2px solid rgba(255, 202, 103, 0.8) !important;
         color: rgba(254, 187, 61, 0.9) !important;
         box-shadow: none !important;
       }

       .zoom-btn-tengods {
         display: inline-flex;
         align-items: center;
         gap: 6px;
         background: rgba(255, 165, 0, 0.3) !important;
         border: 2px solid rgba(255, 202, 103, 0.8) !important;
         color: rgba(254, 187, 61, 0.9) !important;
         box-shadow: none !important;
       }
       
       /* ç§»åŠ¨ç«¯å¤©å¹²å›¾ç‰‡æ ·å¼ */
       .tian-gan-section {
         padding: 20px;
         margin: 15px 0;
       }
       
       .tian-gan-images { 
         grid-template-columns: repeat(2, minmax(150px, 1fr)); 
         gap: 16px; 
         margin: 15px 0 8px;
       }
       
       .tian-gan-card { 
         padding: 16px; 
       }
       
       .tian-gan-card img { 
         max-width: 100px; 
         max-height: 100px; 
       }
       
       .tian-gan-label { 
         font-size: 0.9rem; 
         margin-top: 12px; 
       }
       
       .fusion-section {
         margin-top: 20px;
       }
       
       .fusion-description {
         font-size: 1rem;
         margin-bottom: 20px;
       }
       
       .fusion-btn {
         padding: 14px 28px;
         font-size: 1rem;
       }
       
       .fusion-result img { 
         max-width: 350px; 
         max-height: 350px; 
       }
       
       .fusion-result h3 {
         font-size: 1.2rem;
       }
    }
    /* å¤©å¹²å›¾ç‰‡å±•ç¤ºä¸èåˆ - å”¯ç¾é£æ ¼ */
    .tian-gan-section {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 30px;
      margin: 20px 0;
      box-shadow: 0 20px 60px rgba(255,207,104,0.15);
      border: 1px solid rgba(255,207,104,0.1);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    
    
    
    .tian-gan-images { 
      display: grid; 
      grid-template-columns: repeat(2, minmax(180px, 1fr)); 
      gap: 24px; 
      margin: 20px 0 10px;
      position: relative;
      z-index: 2;
    }
    
    .tian-gan-card { 
      background: rgba(255,255,255,0.95);
      border: 2px solid rgba(255,207,104,0.2);
      border-radius: 18px;
      padding: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(255,207,104,0.1);
    }
    
         .tian-gan-card img { 
       max-width: 140px; 
       max-height: 140px; 
       width: auto; 
       height: auto; 
       border-radius: 16px; 
       box-shadow: 0 8px 24px rgba(0,0,0,0.15);
       filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
     }
    
         .tian-gan-label { 
       margin-top: 16px; 
       font-weight: 700; 
       color: #D97706;
       font-size: 1rem;
       text-shadow: 0 1px 2px rgba(0,0,0,0.1);
       position: relative;
     }
    
    .fusion-section { 
      margin-top: 30px; 
      text-align: center;
      position: relative;
      z-index: 2;
    }
    
    .fusion-description {
      color: #6B7280;
      margin-bottom: 24px;
      font-size: 1.1rem;
      line-height: 1.6;
      font-style: italic;
      text-shadow: 0 1px 2px rgba(255,255,255,0.8);
    }
    
         .fusion-btn { 
       padding: 16px 32px; 
       background: #F59E0B;
       color: #fff; 
       border: 0; 
       border-radius: 50px; 
       cursor: pointer; 
       font-size: 1.1rem;
       font-weight: 600;
       box-shadow: 0 8px 24px rgba(255,207,104,0.3);
       position: relative;
       overflow: hidden;
       letter-spacing: 0.5px;
     }
    
    .fusion-btn:disabled { 
      opacity: 0.7; 
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 4px 12px rgba(255,207,104,0.2);
    }
    
         .fusion-result { 
       display: none; 
       margin-top: 30px;
       text-align: center;
     }
     
          .fusion-result img { 
       max-width: 450px; 
       max-height: 450px; 
       width: auto; 
       height: auto; 
       border-radius: 20px; 
       box-shadow: 0 20px 60px rgba(0,0,0,0.2);
       border: 3px solid rgba(255,207,104,0.3);
       display: block;
       margin: 0 auto;
     }
     
     .fusion-result h3 {
       color: #D97706;
       margin-bottom: 20px;
       font-size: 1.3rem;
       font-weight: 700;
       text-shadow: 0 2px 4px rgba(0,0,0,0.1);
     }
     
          .download-link {
       display: inline-block;
       margin: 16px auto 0;
       padding: 12px 24px;
       background: #10B981;
       color: white;
       text-decoration: none;
       border-radius: 25px;
       font-weight: 600;
       box-shadow: 0 4px 16px rgba(16,185,129,0.3);
     }
  </style>
</head>
<body>
  

    <div class="container">
        <div id="reportContainer" class="report-container">
            
            <div class="loading">
            <div class="loading-icon">ğŸ”®</div>
            <div>æ­£åœ¨ç”Ÿæˆä½ çš„ä¸ªæ€§åŒ–æŠ¥å‘Š...</div>
            </div>
        </div>
    </div>

    <div class="btn-container">
        <a href="/" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            è¿”å›é¦–é¡µ
        </a>
    </div>
  
     <!-- æ”¾å¤§é›·è¾¾å›¾æ¨¡æ€å±‚ -->
   <div id="radarModal" class="modal-overlay" aria-hidden="true">
     <div class="modal-content">
       <button id="radarModalClose" class="modal-close" aria-label="å…³é—­">Ã—</button>
       <canvas id="radarChartLarge"></canvas>
     </div>
   </div>
   
   <!-- æ”¾å¤§åç¥å›¾è¡¨æ¨¡æ€å±‚ -->
   <div id="tenGodsModal" class="modal-overlay" aria-hidden="true">
     <div class="modal-content">
       <button id="tenGodsModalClose" class="modal-close" aria-label="å…³é—­">Ã—</button>
       <canvas id="tenGodsChartLarge"></canvas>
     </div>
   </div>
  <script>
         let reportData = null;
     let largeRadarChart = null;
     let largeTenGodsChart = null;

    // å¤©å¹²åˆ°å›¾ç‰‡æ˜ å°„ï¼ˆå·²æ›´æ–°ä¸ºå®é™…æ–‡ä»¶åï¼‰
    const tianGanToImage = {
      'ç”²': 'jia.jpg','ä¹™': 'yi.jpg','ä¸™': 'bing.jpg','ä¸': 'ding.jpg','æˆŠ': 'wu.jpg',
      'å·±': 'ji.jpg','åºš': 'geng.jpg','è¾›': 'xin.jpg','å£¬': 'ren.jpg','ç™¸': 'gui.jpg'
    };

    // æ ¹æ® baziData æ˜¾ç¤ºå››æŸ±å¤©å¹²å›¾ç‰‡
    function displayTianGanImages(baziData) {
      try{
        const container = document.getElementById('tianGanImages');
        if (!container || !baziData) return;
        const pillars = ['å¹´æŸ±','æœˆæŸ±','æ—¥æŸ±','æ—¶æŸ±'];
        const tgs = [];
        pillars.forEach(p => {
          const tg = baziData[p]?.å¤©å¹²?.å¤©å¹²;
          const img = tg ? tianGanToImage[tg] : null;
          if (tg && img) tgs.push({ pillar: p, tianGan: tg, image: img });
        });
        container.innerHTML = tgs.map(item => `
          <div class="tian-gan-card">
            <img src="/img/${item.image}" alt="${item.pillar}${item.tianGan}">
            <div class="tian-gan-label">${item.pillar} - ${item.tianGan}</div>
          </div>
        `).join('');
        window.currentTianGans = tgs;
      }catch(e){ console.warn('æ˜¾ç¤ºå¤©å¹²å›¾ç‰‡å¤±è´¥:', e); }
    }

    // æ¸²æŸ“å¤©å¹²å›¾ç‰‡ï¼šå…ˆå°è¯•ä»ä¼šè¯å–ï¼Œå¤±è´¥åˆ™ä»æœ¬åœ°å­˜å‚¨å–
    async function ensureTianGanImagesRendered(){
      try{
        const res = await fetch('/get-bazi');
        if(res.ok){
          const data = await res.json();
          if (data && data.baziData) {
            displayTianGanImages(data.baziData);
            return;
          }
        }
      }catch(e){ /* ignore */ }
      try{
        const saved = localStorage.getItem('baziData');
        if(saved){
          const parsed = JSON.parse(saved);
          if (parsed && parsed.baziData) {
            displayTianGanImages(parsed.baziData);
          }
        }
      }catch(e){ console.warn('æœ¬åœ°å¤©å¹²å›¾ç‰‡æ¸²æŸ“å¤±è´¥:', e); }
    }

    // AIå›¾ç‰‡èåˆ - ç”Ÿæˆå…¨æ–°å›¾ç‰‡
    async function startImageFusion() {
      try{
        const tgs = (window.currentTianGans || []).slice(0, 4);
        if (tgs.length < 4) { 
          alert('âŒ éœ€è¦å››å¼ å¤©å¹²å›¾ç‰‡æ‰èƒ½è¿›è¡ŒAIèåˆ\nè¯·ç¡®ä¿å…«å­—æ•°æ®å·²æ­£ç¡®ç”Ÿæˆ'); 
          return; 
        }
        
        const btn = document.getElementById('fusionBtn');
        const result = document.getElementById('fusionResult');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIæ­£åœ¨åˆ›ä½œ...';
        
        const resp = await fetch('/api/fuse-images', {
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            tianGans: tgs.map(x => ({ 
              pillar: x.pillar, 
              tianGan: x.tianGan, 
              imagePath: `/img/${x.image}` 
            })) 
          })
        });
        
        if (!resp.ok) {
          const errorData = await resp.json().catch(() => ({}));
          throw new Error(errorData.message || `æœåŠ¡å™¨é”™è¯¯ ${resp.status}`);
        }
        
        const data = await resp.json();
        const url = data.fusedImageDataUrl;
        
        if (!url) {
          throw new Error('AIæœªè¿”å›ç”Ÿæˆçš„å›¾ç‰‡æ•°æ®');
        }
        
        // æ˜¾ç¤ºAIç”Ÿæˆçš„å…¨æ–°å›¾ç‰‡
        document.getElementById('fusedImage').src = url;
        const download = document.getElementById('downloadFused');
        if (download) {
          download.href = url;
          download.download = `å…«å­—å¤©å¹²èåˆ-${new Date().getTime()}.png`;
        }
        result.style.display = 'block';
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.innerHTML = 'ğŸ¨ é‡æ–°ç”Ÿæˆ';
        btn.disabled = false;
        
      }catch(e){
        console.error('AIå›¾ç‰‡èåˆå¤±è´¥:', e);
        
        // æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
        let errorMsg = 'ğŸ¤– AIå›¾ç‰‡èåˆå¤±è´¥\n\n';
        if (e.message.includes('401') || e.message.includes('403')) {
          errorMsg += 'âŒ APIå¯†é’¥æ— æ•ˆæˆ–æƒé™ä¸è¶³\nè¯·æ£€æŸ¥GEMINI_API_KEYæ˜¯å¦æ­£ç¡®é…ç½®';
        } else if (e.message.includes('500')) {
          errorMsg += 'âŒ æœåŠ¡å™¨å†…éƒ¨é”™è¯¯\nè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜';
        } else {
          errorMsg += `âŒ ${e.message}\n\nğŸ’¡ è¯·ç¡®ä¿ï¼š\n- ç½‘ç»œè¿æ¥æ­£å¸¸\n- APIæœåŠ¡å¯ç”¨\n- å›¾ç‰‡æ–‡ä»¶å­˜åœ¨`;
        }
        
        alert(errorMsg);
        
        // æ¢å¤æŒ‰é’®
        const btn = document.getElementById('fusionBtn');
        if (btn) {
          btn.innerHTML = 'ğŸ”„ é‡è¯•èåˆ';
          btn.disabled = false;
        }
      }
    }

    // è§„èŒƒåŒ–ä¸­æ–‡æ ‡ç‚¹ï¼šç§»é™¤å¥æœ«æ ‡ç‚¹åçš„å¤šä½™é€—å·ç­‰ï¼Œå¦‚ â€œã€‚ï¼Œâ€ã€â€œã€‚ï¼Œâ€
    function sanitizeChinesePunctuation(text){
      if(typeof text !== 'string') return text;
      let t = text;
      // å»æ‰å¥æœ«æ ‡ç‚¹åç´§è·Ÿçš„é€—å·/é¡¿å·/ç©ºæ ¼
      t = t.replace(/([ã€‚ï¼ï¼Ÿï¼›])\s*[ï¼Œ,]/g, '$1');
      // å¤„ç†é‡å¤å¥å·æˆ–æ··åˆï¼ˆå¯é€‰ï¼‰
      t = t.replace(/ã€‚{2,}/g, 'ã€‚');
      return t;
    }

    // ç”Ÿæˆå››æŸ±æ³¡æ³¡ HTML
    function buildPillarsBubbles(baziData){
      try{
        if(!baziData) return '';
        const pillarsOrder = [
          ['å¹´æŸ±','å¹´æŸ±'],
          ['æœˆæŸ±','æœˆæŸ±'],
          ['æ—¥æŸ±','æ—¥æŸ±'],
          ['æ—¶æŸ±','æ—¶æŸ±']
        ];
        const cards = pillarsOrder.map(([key,label]) => {
          const p = baziData[key] || {};
          const stem = p.å¤©å¹²?.å¤©å¹² || '';
          const stemYY = p.å¤©å¹²?.é˜´é˜³ || '';
          const stemTG = p.å¤©å¹²?.åç¥ || '';
          const branch = p.åœ°æ”¯?.åœ°æ”¯ || '';
          const branchYY = p.åœ°æ”¯?.é˜´é˜³ || '';
          const mainHiddenStem = p.åœ°æ”¯?.è—å¹²?.ä¸»æ°”?.å¤©å¹² || '';
          const mainHiddenTenGod = p.åœ°æ”¯?.è—å¹²?.ä¸»æ°”?.åç¥ || '';
          if(!stem && !branch) return '';
          return `
            <div class="pillar-bubble-card">
              <div class="pillar-bubble-title">${label}</div>
              <div class="bubble-row">
                <span class="bubble bubble-stem">ã€å¤©å¹²ã€‘${stem || 'â€”'}${stemYY ? ` Â· ${stemYY}` : ''}${stemTG ? ` Â· ${stemTG}` : ''}</span>
                <span class="bubble bubble-branch">ã€åœ°æ”¯ã€‘${branch || 'â€”'}${branchYY ? ` Â· ${branchYY}` : ''}</span>
              </div>
              ${(mainHiddenStem || mainHiddenTenGod) ? `
              <div class="bubble-row" style="margin-top:10px;">
                <span class="bubble bubble-hidden">ã€è—å¹²ã€‘${mainHiddenStem}${mainHiddenTenGod ? ` Â· ${mainHiddenTenGod}` : ''}</span>
              </div>` : ''}
            </div>
          `;
        }).join('');
        if(!cards.trim()) return '';
        // æ¸²æŸ“åå¡«å……å¤©å¹²å›¾ç‰‡
        setTimeout(() => { try{ ensureTianGanImagesRendered(); } catch(_){} }, 0);
        return `
          <div class="section">
            <div class="section-header">
              <i class="fas fa-bahai section-icon"></i>
              <h2 class="section-title">å››æŸ±ç»“æ„</h2>
            </div>
            <div class="pillars-bubbles">${cards}</div>
          </div>

          <div class="section">
            <div class="section-header">
              <i class="fas fa-images section-icon"></i>
              <h2 class="section-title">å¤©å¹²å›¾</h2>
            </div>
            <div class="tian-gan-section">
              <div id="tianGanImages" class="tian-gan-images"></div>
              <div class="fusion-section">
                <p class="fusion-description">
                  âœ¨ åŸºäºæ‚¨çš„å…«å­—å¤©å¹²ï¼ŒAIå°†åˆ›é€ æ€§åœ°èåˆå››å¼ å¤©å¹²å›¾ç‰‡ï¼Œç”Ÿæˆä¸€å¼ ç‹¬ç‰¹çš„è‰ºæœ¯ä½œå“
                </p>
                <button id="fusionBtn" class="fusion-btn" onclick="startImageFusion()">
                  <i class="fas fa-magic"></i> ğŸ¨ AIåˆ›ä½œèåˆå›¾ç‰‡
                </button>
                <div id="fusionResult" class="fusion-result">
                  <h3>âœ¨ èåˆç»“æœ</h3>
                  <img id="fusedImage" alt="èåˆç»“æœ">
                  <a id="downloadFused" class="download-link" download="bazi-fused.png">
                    <i class="fas fa-download"></i> ä¸‹è½½èåˆå›¾ç‰‡
                  </a>
                </div>
              </div>
            </div>
          </div>
        `;
      }catch(e){
        console.warn('æ„å»ºå››æŸ±æ³¡æ³¡å¤±è´¥:', e);
        return '';
      }
    }

    // è·å– BaZi æ•°æ®ï¼ˆä¼˜å…ˆ sessionï¼Œå…¶æ¬¡æœ¬åœ°ï¼‰å¹¶è¿”å›æ³¡æ³¡åŒºå— HTML
    async function fetchBaziSectionHtml(){
      try{
        const res = await fetch('/get-bazi');
        if(res.ok){
          const data = await res.json();
          return buildPillarsBubbles(data.baziData);
        }
      }catch(e){
        // ignore and fallback to localStorage
      }
      try{
        const saved = localStorage.getItem('baziData');
        if(saved){
          const parsed = JSON.parse(saved);
          return buildPillarsBubbles(parsed?.baziData);
        }
      }catch(e){
        console.warn('è¯»å–æœ¬åœ° BaZi å¤±è´¥:', e);
      }
      return '';
    }

    // è·å–æŠ¥å‘Šæ•°æ®
    async function fetchReport() {
      const reportContainer = document.getElementById('reportContainer');
      
      try {
        // æå‰è·å–å››æŸ±æ³¡æ³¡åŒºå—
        const pillarsSectionHtml = await fetchBaziSectionHtml();
        
        const response = await fetch('/get-report');
        
        if (!response.ok) {
          throw new Error('æœªæ‰¾åˆ°æŠ¥å‘Šï¼Œè¯·å…ˆç”ŸæˆæŠ¥å‘Šã€‚');
        }
        
        const data = await response.json();
        let report = data.report;
        
        // Try to parse if it's a JSON string
        if (typeof report === 'string') {
          try {
            report = JSON.parse(report);
          } catch (e) {
            // Not JSON, use as-is
          }
        }
        
        // Format the report based on content type
        if (typeof report === 'string') {
          // Plain text report
          const cleanText = sanitizeChinesePunctuation(report);
          reportContainer.innerHTML = `
            <div class="fade-in">
              ${pillarsSectionHtml}
              <div class="section">
                <div class="content-card full-width-card">
                  <div class="summary-text">${cleanText.replace(/\n/g, '<br>')}</div>
                </div>
              </div>
            </div>
          `;
        } else {
          // JSON structured report
          displayReport(report, pillarsSectionHtml);
        }
      } catch (error) {
        reportContainer.innerHTML = `
          <div class="error">
            <div class="error-icon">âš ï¸</div>
            <div>é”™è¯¯: ${error.message}</div>
          </div>
        `;
      }
    }

    // æ˜¾ç¤ºæŠ¥å‘Š
    function displayReport(report, prefixHtml = '') {
      const reportContainer = document.getElementById('reportContainer');
      let html = '';

      if (report.polygonChart) {
        html += `
          <div class="section">
            <div class="section-header">
              <i class="fas fa-chart-radar section-icon"></i>
              <h2 class="section-title">äººæ ¼ç»´åº¦åˆ†æ</h2>
            </div>
            <div class="chart-section">
              <div class="radar-chart-container">
                <button id="zoomRadarBtn" class="zoom-btn" title="æ”¾å¤§æŸ¥çœ‹"><i class="fas fa-magnifying-glass-plus"></i></button>
                <canvas id="radarChart" class="radar-chart"></canvas>
              </div>
            </div>
          </div>
        `;
        
        // å­˜å‚¨é›·è¾¾å›¾æ•°æ®ï¼Œç¨åç”¨äºç”Ÿæˆå›¾è¡¨
        window.radarChartData = {
          labels: Object.keys(report.polygonChart).map(key => {
            const dimensionNames = {
              'leadershipAndIndependence': 'é¢†å¯¼åŠ›ä¸ç‹¬ç«‹æ€§',
              'empathyAndConnection': 'åŒç†å¿ƒä¸äººé™…è¿æ¥',
              'creativityAndExpression': 'åˆ›é€ åŠ›ä¸è¡¨è¾¾',
              'analyticalAndStrategicMind': 'åˆ†æä¸æˆ˜ç•¥æ€ç»´',
              'diligenceAndReliability': 'å‹¤å‹‰ä¸å¯é æ€§',
              'adventurousAndAdaptableSpirit': 'å†’é™©ç²¾ç¥ä¸é€‚åº”åŠ›'
            };
            return dimensionNames[key] || key;
          }),
          values: Object.values(report.polygonChart)
        };
      }

      // æ·»åŠ åç¥è¯„åˆ†æ˜¾ç¤º
      if (report.tenGodsScores) {
        html += `
          <div class="section">
            <div class="section-header">
              <i class="fas fa-yin-yang section-icon"></i>
              <h2 class="section-title">åç¥è¯„åˆ†åˆ†æ</h2>
            </div>
                         <div class="chart-section">
               <div class="tengods-chart-container">
                 <button id="zoomTenGodsBtn" class="zoom-btn-tengods" title="æ”¾å¤§æŸ¥çœ‹"><i class="fas fa-magnifying-glass-plus"></i></button>
                 <canvas id="tenGodsChart" class="tengods-chart"></canvas>
               </div>
             </div>
          </div>
        `;
        
        // å­˜å‚¨åç¥å›¾è¡¨æ•°æ®
        window.tenGodsChartData = {
          labels: Object.keys(report.tenGodsScores),
          values: Object.values(report.tenGodsScores)
        };
      }

      if (report.personalityProfile) {
        html += `
          <div class="section">
            <div class="section-header">
              <i class="fas fa-user-circle section-icon"></i>
              <h2 class="section-title">æ€§æ ¼æ¦‚å†µ</h2>
            </div>
            <div class="content-grid">
              <div class="content-card full-width-card">
                <div class="card-title">
                  <i class="fas fa-lightbulb"></i>
                  ç»¼åˆæ¦‚è¿°
                </div>
                <div class="summary-text">${report.personalityProfile.summary}</div>
              </div>
              
              <div class="content-card">
                <div class="card-title">
                  <i class="fas fa-star"></i>
                  æ ¸å¿ƒä¼˜åŠ¿
                </div>
                <ul class="custom-list">
        `;
        
        report.personalityProfile.strengths.forEach(strength => {
          html += `<li>${strength}</li>`;
        });
        
        html += `
                </ul>
              </div>
              
              <div class="content-card">
                <div class="card-title">
                  <i class="fas fa-target"></i>
                  æˆé•¿æŒ‘æˆ˜
                </div>
                <ul class="custom-list challenge-list">
        `;
        
        report.personalityProfile.challenges.forEach(challenge => {
          html += `<li>${challenge}</li>`;
        });
        
        html += `
                </ul>
              </div>
              
              <div class="content-card full-width-card">
                <div class="card-title">
                  <i class="fas fa-comments"></i>
                  æ²Ÿé€šé£æ ¼
                </div>
                <div class="communication-style">
                  <div class="communication-text">${report.personalityProfile.communicationStyle}</div>
                </div>
              </div>
              
              <div class="content-card full-width-card">
                <div class="card-title">
                  <i class="fas fa-briefcase"></i>
                  èŒä¸šå‘å±•å»ºè®®
                </div>
                <ul class="custom-list career-list">
        `;
        
        report.personalityProfile.careerSuggestions.forEach(career => {
          html += `<li>${career}</li>`;
        });
        
        html += `
                </ul>
              </div>
            </div>
          </div>
        `;
      }

      if (report.practicalAdvice) {
        const adviceItemsRaw = Array.isArray(report.practicalAdvice) ? report.practicalAdvice : [report.practicalAdvice];
        const adviceItems = adviceItemsRaw
          .filter(Boolean)
          .map(i => sanitizeChinesePunctuation(String(i)));
        html += `
          <div class="section">
            <div class="section-header">
              <i class="fas fa-compass section-icon"></i>
              <h2 class="section-title">å®ç”¨ç”Ÿæ´»å»ºè®®</h2>
            </div>
            <div class="content-card">
              <div class="card-title">
                <i class="fas fa-lightbulb"></i>
                ç”Ÿæ´»æŒ‡å¯¼
              </div>
              <ul class="custom-list">
                ${adviceItems.map(item => `<li>${item}</li>`).join('')}
              </ul>
            </div>
          </div>
        `;
      }

      if (report.reflectiveQuestions) {
        html += `
          <div class="section">
            <div class="section-header">
              <i class="fas fa-question-circle section-icon"></i>
              <h2 class="section-title">æ·±åº¦æ€è€ƒ</h2>
            </div>
            <div class="content-card">
              <div class="card-title">
                <i class="fas fa-brain"></i>
                åæ€é—®é¢˜
              </div>
              <ul class="custom-list">
        `;
        
        report.reflectiveQuestions.forEach(question => {
          html += `<li>${question}</li>`;
        });
        
        html += `
              </ul>
            </div>
          </div>
        `;
      }

      reportContainer.innerHTML = prefixHtml + html;
      
      // ç”Ÿæˆé›·è¾¾å›¾
      if (window.radarChartData) {
        setTimeout(() => {
          createRadarChart();
        }, 100);
      }
      
                // ç”Ÿæˆåç¥å›¾è¡¨
     if (window.tenGodsChartData) {
       setTimeout(() => {
         createTenGodsChart();
       }, 200);
     }
   }

  // æ‰“å¼€é›·è¾¾å›¾æ¨¡æ€å±‚å¹¶ç»˜åˆ¶å¤§å›¾
  function openRadarModal() {
    const modal = document.getElementById('radarModal');
    const closeBtn = document.getElementById('radarModalClose');
    modal.style.display = 'flex';

    // é”€æ¯æ—§å®ä¾‹é¿å…é‡å¤ç»‘å®š
    if (largeRadarChart) {
      try { largeRadarChart.destroy(); } catch (e) {}
      largeRadarChart = null;
    }

    const ctx = document.getElementById('radarChartLarge');
    if (!ctx || !window.radarChartData) return;

    largeRadarChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: window.radarChartData.labels,
        datasets: [{
          label: 'äººæ ¼ç»´åº¦è¯„åˆ†ï¼ˆæ”¾å¤§ï¼‰',
          data: window.radarChartData.values,
          backgroundColor: 'rgba(255, 207, 104, 0.2)',
          borderColor: 'rgba(255, 207, 104, 1)',
          borderWidth: 3,
          pointBackgroundColor: 'rgba(255, 207, 104, 1)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          r: {
            beginAtZero: true,
            min: 0,
            max: 10,
            ticks: { stepSize: 2, color: '#666' },
            grid: { color: 'rgba(102, 102, 102, 0.3)' },
            angleLines: { color: 'rgba(102, 102, 102, 0.3)' },
            pointLabels: { color: '#000' }
          }
        }
      }
    });

    // å…³é—­äº‹ä»¶
    closeBtn.onclick = closeRadarModal;
    modal.onclick = (e) => { if (e.target === modal) closeRadarModal(); };
    document.addEventListener('keydown', escCloseHandler);
  }

  function escCloseHandler(e){ if (e.key === 'Escape') closeRadarModal(); }

  function closeRadarModal() {
    const modal = document.getElementById('radarModal');
    modal.style.display = 'none';
    if (largeRadarChart) {
      try { largeRadarChart.destroy(); } catch (e) {}
      largeRadarChart = null;
    }
         document.removeEventListener('keydown', escCloseHandler);
   }

   // æ‰“å¼€åç¥å›¾è¡¨æ¨¡æ€å±‚å¹¶ç»˜åˆ¶å¤§å›¾
   function openTenGodsModal() {
     const modal = document.getElementById('tenGodsModal');
     const closeBtn = document.getElementById('tenGodsModalClose');
     modal.style.display = 'flex';

     // é”€æ¯æ—§å®ä¾‹é¿å…é‡å¤ç»‘å®š
     if (largeTenGodsChart) {
       try { largeTenGodsChart.destroy(); } catch (e) {}
       largeTenGodsChart = null;
     }

     const ctx = document.getElementById('tenGodsChartLarge');
     if (!ctx || !window.tenGodsChartData) return;

     largeTenGodsChart = new Chart(ctx, {
       type: 'radar',
       data: {
         labels: window.tenGodsChartData.labels,
         datasets: [{
           label: 'åç¥è¯„åˆ†ï¼ˆæ”¾å¤§ï¼‰',
           data: window.tenGodsChartData.values,
           backgroundColor: 'rgba(255, 207, 104, 0.2)',
           borderColor: 'rgba(255, 207, 104, 1)',
           borderWidth: 3,
           pointBackgroundColor: 'rgba(255, 207, 104, 1)',
           pointBorderColor: '#fff',
           pointBorderWidth: 2,
           pointRadius: 5,
           pointHoverRadius: 7
         }]
       },
       options: {
         responsive: true,
         maintainAspectRatio: false,
         plugins: { legend: { display: false } },
         scales: {
           r: {
             beginAtZero: true,
             min: 0,
             max: 10,
             ticks: { stepSize: 2, color: '#666' },
             grid: { color: 'rgba(102, 102, 102, 0.3)' },
             angleLines: { color: 'rgba(102, 102, 102, 0.3)' },
             pointLabels: { color: '#000' }
           }
         }
       }
     });

     // å…³é—­äº‹ä»¶
     closeBtn.onclick = closeTenGodsModal;
     modal.onclick = (e) => { if (e.target === modal) closeTenGodsModal(); };
     document.addEventListener('keydown', escCloseHandlerTenGods);
   }

   function escCloseHandlerTenGods(e){ if (e.key === 'Escape') closeTenGodsModal(); }

   function closeTenGodsModal() {
     const modal = document.getElementById('tenGodsModal');
     modal.style.display = 'none';
     if (largeTenGodsChart) {
       try { largeTenGodsChart.destroy(); } catch (e) {}
       largeTenGodsChart = null;
     }
     document.removeEventListener('keydown', escCloseHandlerTenGods);
   }

    // ç”Ÿæˆé›·è¾¾å›¾
    function createRadarChart() {
      const ctx = document.getElementById('radarChart');
      if (!ctx || !window.radarChartData) return;

      // è‡ªå®šä¹‰æ’ä»¶ï¼šåœ¨é¡¶ç‚¹æ˜¾ç¤ºæ•°å­—
      const vertexLabelPlugin = {
        id: 'vertexLabels',
        afterDraw: function(chart) {
          const ctx = chart.ctx;
          const meta = chart.getDatasetMeta(0);
          
          if (!meta.data) return;
          
          ctx.save();
          ctx.font = 'bold 16px Noto Sans SC, Microsoft YaHei, sans-serif';
          ctx.fillStyle = '#FFCF68';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          
          meta.data.forEach((point, index) => {
            const value = window.radarChartData.values[index];
            const x = point.x;
            const y = point.y;
            
            // è®¡ç®—æ ‡ç­¾ä½ç½®ï¼Œé¿å…ä¸è½´æ ‡ç­¾é‡å 
            const angle = (index * 2 * Math.PI) / meta.data.length - Math.PI / 2;
            const offsetX = Math.cos(angle) * 20;
            const offsetY = Math.sin(angle) * 20;
            
            // ç»˜åˆ¶æ–‡å­—
            const text = value.toString();
            const textWidth = ctx.measureText(text).width;
            const padding = 4;
            
            // ç»˜åˆ¶èƒŒæ™¯æ¡†
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.fillRect(
              x + offsetX - textWidth/2 - padding, 
              y + offsetY - 8 - padding, 
              textWidth + padding * 2, 
              16 + padding * 2
            );
            
            // ç»˜åˆ¶è¾¹æ¡†
            ctx.strokeStyle = 'rgba(255, 207, 104, 0.5)';
            ctx.lineWidth = 1;
            ctx.strokeRect(
              x + offsetX - textWidth/2 - padding, 
              y + offsetY - 8 - padding, 
              textWidth + padding * 2, 
              16 + padding * 2
            );
            
            // ç»˜åˆ¶æ–‡å­—
            ctx.fillStyle = '#FFCF68';
            ctx.fillText(text, x + offsetX, y + offsetY);
          });
          
          ctx.restore();
        }
      };

      new Chart(ctx, {
        type: 'radar',
        plugins: [vertexLabelPlugin],
        data: {
          labels: window.radarChartData.labels,
          datasets: [{
            label: 'äººæ ¼ç»´åº¦è¯„åˆ†',
            data: window.radarChartData.values,
            backgroundColor: 'rgba(255, 207, 104, 0.2)',
            borderColor: 'rgba(255, 207, 104, 1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgba(255, 207, 104, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointHoverBackgroundColor: 'rgba(255, 207, 104, 1)',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              titleColor: '#000000',
              bodyColor: '#000000',
              borderColor: 'rgba(255, 207, 104, 1)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return context.parsed.r + '/10';
                }
              }
            }
          },
          scales: {
            r: {
              beginAtZero: true,
              min: 0,
              max: 10,
              ticks: {
                stepSize: 2,
                color: '#666666',
                font: {
                  size: 12,
                  family: 'Noto Sans SC, Microsoft YaHei, sans-serif'
                },
                backdropColor: 'transparent'
              },
              grid: {
                color: 'rgba(102, 102, 102, 0.3)',
                lineWidth: 1
              },
              angleLines: {
                color: 'rgba(102, 102, 102, 0.3)',
                lineWidth: 1
              },
              pointLabels: {
                color: '#000000',
                font: {
                  size: 13,
                  weight: '600',
                  family: 'Noto Sans SC, Microsoft YaHei, sans-serif'
                },
                padding: 20
              }
            }
          },
          elements: {
            line: {
              tension: 0.1
            }
          },
          interaction: {
            intersect: false
          }
        }
      });

           // ç»‘å®šæ”¾å¤§æŒ‰é’®
     const zoomBtn = document.getElementById('zoomRadarBtn');
     if (zoomBtn) {
       zoomBtn.onclick = () => openRadarModal();
     }
   }

   // ç”Ÿæˆåç¥å›¾è¡¨
   function createTenGodsChart() {
     const ctx = document.getElementById('tenGodsChart');
     if (!ctx || !window.tenGodsChartData) return;

     // è‡ªå®šä¹‰æ’ä»¶ï¼šåœ¨é¡¶ç‚¹æ˜¾ç¤ºæ•°å­—
     const vertexLabelPlugin = {
       id: 'tenGodsVertexLabels',
       afterDraw: function(chart) {
         const ctx = chart.ctx;
         const meta = chart.getDatasetMeta(0);
         
         if (!meta.data) return;
         
         ctx.save();
         ctx.font = 'bold 14px Noto Sans SC, Microsoft YaHei, sans-serif';
         ctx.fillStyle = '#FFCF68';
         ctx.textAlign = 'center';
         ctx.textBaseline = 'middle';
         
         meta.data.forEach((point, index) => {
           const value = window.tenGodsChartData.values[index];
           const x = point.x;
           const y = point.y;
           
           // è®¡ç®—æ ‡ç­¾ä½ç½®ï¼Œé¿å…ä¸è½´æ ‡ç­¾é‡å 
           const angle = (index * 2 * Math.PI) / meta.data.length - Math.PI / 2;
           const offsetX = Math.cos(angle) * 25;
           const offsetY = Math.sin(angle) * 25;
           
           // ç»˜åˆ¶æ–‡å­—
           const text = value.toString();
           const textWidth = ctx.measureText(text).width;
           const padding = 4;
           
           // ç»˜åˆ¶èƒŒæ™¯æ¡†
           ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
           ctx.fillRect(
             x + offsetX - textWidth/2 - padding, 
             y + offsetY - 8 - padding, 
             textWidth + padding * 2, 
             16 + padding * 2
           );
           
           // ç»˜åˆ¶è¾¹æ¡†
           ctx.strokeStyle = 'rgba(255, 207, 104, 0.6)';
           ctx.lineWidth = 1;
           ctx.strokeRect(
             x + offsetX - textWidth/2 - padding, 
             y + offsetY - 8 - padding, 
             textWidth + padding * 2, 
             16 + padding * 2
           );
           
           // ç»˜åˆ¶æ–‡å­—
           ctx.fillStyle = '#FFCF68';
           ctx.fillText(text, x + offsetX, y + offsetY);
         });
         
         ctx.restore();
       }
     };

     new Chart(ctx, {
       type: 'radar',
       plugins: [vertexLabelPlugin],
       data: {
         labels: window.tenGodsChartData.labels,
         datasets: [{
           label: 'åç¥è¯„åˆ†',
           data: window.tenGodsChartData.values,
           backgroundColor: 'rgba(255, 207, 104, 0.2)',
           borderColor: 'rgba(255, 207, 104, 1)',
           borderWidth: 3,
           pointBackgroundColor: 'rgba(255, 207, 104, 1)',
           pointBorderColor: '#fff',
           pointBorderWidth: 2,
           pointRadius: 6,
           pointHoverRadius: 8,
           pointHoverBackgroundColor: 'rgba(230, 184, 77, 1)',
           pointHoverBorderColor: '#fff',
           pointHoverBorderWidth: 2
         }]
       },
       options: {
         responsive: true,
         maintainAspectRatio: true,
         plugins: {
           legend: {
             display: false
           },
           tooltip: {
             backgroundColor: 'rgba(255, 255, 255, 0.9)',
             titleColor: '#000000',
             bodyColor: '#000000',
             borderColor: 'rgba(255, 207, 104, 1)',
             borderWidth: 1,
             cornerRadius: 8,
             displayColors: false,
             callbacks: {
               label: function(context) {
                 return context.parsed.r + '/10';
               }
             }
           }
         },
         scales: {
           r: {
             beginAtZero: true,
             min: 0,
             max: 10,
             ticks: {
               stepSize: 2,
               color: '#666666',
               font: {
                 size: 12,
                 family: 'Noto Sans SC, Microsoft YaHei, sans-serif'
               },
               backdropColor: 'transparent'
             },
             grid: {
               color: 'rgba(102, 102, 102, 0.3)',
               lineWidth: 1
             },
             angleLines: {
               color: 'rgba(102, 102, 102, 0.3)',
               lineWidth: 1
             },
             pointLabels: {
               color: '#000000',
               font: {
                 size: 13,
                 weight: '600',
                 family: 'Noto Sans SC, Microsoft YaHei, sans-serif'
               },
               padding: 20
             }
           }
         },
         elements: {
           line: {
             tension: 0.1
           }
         },
         interaction: {
           intersect: false
         }
       }
     });

     // ç»‘å®šæ”¾å¤§æŒ‰é’®
     const zoomTenGodsBtn = document.getElementById('zoomTenGodsBtn');
     if (zoomTenGodsBtn) {
       zoomTenGodsBtn.onclick = () => openTenGodsModal();
     }
   }

    // é¡µé¢åŠ è½½æ—¶è·å–æŠ¥å‘Š
    window.addEventListener('DOMContentLoaded', fetchReport);
  </script>
</body>
</html> 