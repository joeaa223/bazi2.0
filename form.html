<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…«å­—å‘½ç† Â· æ¢ç´¢ä½ çš„äººç”Ÿå¯†ç </title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    /* èƒŒæ™¯è£…é¥° */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
      pointer-events: none;
    }

    .container {
      background: rgba(26, 26, 46, 0.9);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 1000px;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .logo {
      font-size: 3rem;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .title {
      font-size: 2rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #a0aec0;
      font-size: 1rem;
      font-weight: 400;
    }

    .form-group {
      margin-bottom: 24px;
      position: relative;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-label i {
      color: #00d4ff;
      font-size: 1rem;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #00d4ff;
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
      transform: translateY(-2px);
    }

    .form-input:disabled, .form-select:disabled {
      background: rgba(255, 255, 255, 0.05);
      color: #718096;
      cursor: not-allowed;
    }

    .gender-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }

    .gender-option {
      position: relative;
    }

    .gender-radio {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .gender-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.1);
      color: #e2e8f0;
      font-weight: 500;
      gap: 8px;
    }

    .gender-radio:checked + .gender-label {
      border-color: #00d4ff;
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
    }

    .date-time-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .submit-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 32px;
      position: relative;
      overflow: hidden;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(0, 212, 255, 0.4);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    .submit-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .submit-btn:hover::before {
      left: 100%;
    }

    .result-section {
      margin-top: 32px;
      padding: 24px;
      background: rgba(26, 26, 46, 0.8);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: none;
    }

    .result-section.show {
      display: block;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result-content {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-family: 'Inter', 'Microsoft YaHei', sans-serif;
      font-size: 0.9rem;
      line-height: 1.6;
      max-height: none;
      overflow-y: visible;
      color: #e2e8f0;
    }

    .bazi-info {
      margin-bottom: 24px;
    }

    .basic-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
    }

    .info-item {
      text-align: center;
    }

    .info-label {
      font-size: 0.8rem;
      color: #a0aec0;
      margin-bottom: 4px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }

    .info-value {
      font-weight: 600;
      color: #ffffff;
      font-size: 0.9rem;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }

    .pillars-section {
      margin-top: 24px;
    }

    .pillars-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 16px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }

    .pillars-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .pillar-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .pillar-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
    }

    .pillar-header {
      font-size: 0.8rem;
      color: #a0aec0;
      margin-bottom: 8px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }

    .pillar-main {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 12px;
      letter-spacing: 2px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }

    .pillar-details {
      font-size: 0.75rem;
      line-height: 1.4;
      font-family: 'SimSun', 'å®‹ä½“', serif;
      color: #e2e8f0;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .detail-label {
      color: #a0aec0;
      font-size: 20px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }

    .detail-value {
      font-weight: 500;
      color: #ffffff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 20px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }

    /* äº”è¡Œé¢œè‰² */
    .element-wood { background: #c6f6d5; color: #22543d; }
    .element-fire { background: #fed7d7; color: #742a2a; }
    .element-earth { background: #faf089; color: #744210; }
    .element-metal { background: #e2e8f0; color: #2d3748; }
    .element-water { background: #bee3f8; color: #2a4365; }

    /* åç¥é¢œè‰² */
    .tenshen { 
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      color: white;
      font-weight: 600;
    }

    .dayun-section {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-top: 16px;
    }

    .dayun-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 12px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }

    .dayun-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .dayun-item {
      text-align: center;
    }

    .dayun-label {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-bottom: 4px;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }

    .dayun-value {
      font-weight: 600;
      font-size: 0.9rem;
      font-family: 'SimSun', 'å®‹ä½“', serif;
    }

         .action-buttons {
       display: flex;
       gap: 12px;
       margin-top: 20px;
     }

     .action-btn {
       flex: 1;
       padding: 14px 20px;
       border: none;
       border-radius: 10px;
       font-weight: 600;
       cursor: pointer;
       transition: all 0.3s ease;
       text-decoration: none;
       text-align: center;
       display: inline-block;
     }

     .btn-chat {
       background: linear-gradient(135deg, #48bb78, #38a169);
       color: white;
     }

     .btn-report {
       background: linear-gradient(135deg, #ed8936, #dd6b20);
       color: white;
     }

     .btn-edit {
       background: linear-gradient(135deg, #9f7aea, #805ad5);
       color: white;
     }

     .btn-report2 {
       background: linear-gradient(135deg, #3182ce, #2b6cb0);
       color: white;
     }

     .action-btn:hover {
       transform: translateY(-2px);
       box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
     }

     .loading {
       display: inline-flex;
       align-items: center;
       gap: 8px;
       color: #00d4ff;
     }

     .spinner {
       width: 16px;
       height: 16px;
       border: 2px solid rgba(255, 255, 255, 0.2);
       border-top: 2px solid #00d4ff;
       border-radius: 50%;
       animation: spin 1s linear infinite;
     }

     @keyframes spin {
       0% { transform: rotate(0deg); }
       100% { transform: rotate(360deg); }
     }

     .error {
       color: #fed7d7;
       background: rgba(229, 62, 62, 0.2);
       padding: 12px 16px;
       border-radius: 8px;
       margin-top: 16px;
       border: 1px solid rgba(229, 62, 62, 0.3);
     }

     /* å“åº”å¼è°ƒæ•´ */
     @media (max-width: 768px) {
       body {
         background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
         padding: 0;
         margin: 0;
       }
       
       body::before {
         display: block;
       }
       
       .container {
         background: rgba(26, 26, 46, 0.9);
         backdrop-filter: blur(20px);
         box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
         border: 1px solid rgba(255, 255, 255, 0.1);
         padding: 20px;
         margin: 20px;
         width: calc(100% - 40px);
         max-width: none;
       }
       
       .header {
         margin-bottom: 30px;
       }
       
       .logo {
         font-size: 2.5rem;
       }
       
       .title {
         font-size: 1.8rem;
       }
       
       .subtitle {
         font-size: 0.9rem;
       }
       
       .form-group {
         margin-bottom: 20px;
       }
       
       .form-label {
         font-size: 0.85rem;
       }
       
       .form-input, .form-select {
         padding: 12px 16px;
         font-size: 0.9rem;
       }
       
       .gender-group {
         gap: 12px;
       }
       
       .gender-label {
         padding: 10px 16px;
         font-size: 0.9rem;
       }
       
       .submit-btn {
         padding: 14px 20px;
         font-size: 1rem;
       }
       
       .result-section {
         padding: 20px;
         margin-top: 20px;
       }
       
       .result-title {
         font-size: 1.3rem;
       }
       
       .action-buttons {
         flex-direction: column;
         gap: 12px;
       }
       
       .action-btn {
         padding: 12px 16px;
         font-size: 0.9rem;
       }
     }

     @media (max-width: 640px) {
       body {
         background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
         padding: 0;
         margin: 0;
       }
       
       body::before {
         display: block;
       }
       
       .container {
         background: rgba(26, 26, 46, 0.9);
         backdrop-filter: blur(20px);
         box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
         border: 1px solid rgba(255, 255, 255, 0.1);
         padding: 15px;
         margin: 15px;
         width: calc(100% - 30px);
         max-width: none;
       }
       
       .header {
         margin-bottom: 25px;
       }
       
       .logo {
         font-size: 2.2rem;
       }
       
       .title {
         font-size: 1.5rem;
       }
       
       .subtitle {
         font-size: 0.85rem;
       }
       
       .form-group {
         margin-bottom: 18px;
       }
       
       .form-label {
         font-size: 0.8rem;
       }
       
       .form-input, .form-select {
         padding: 10px 14px;
         font-size: 0.85rem;
       }
       
       .gender-group {
         gap: 10px;
       }
       
       .gender-label {
         padding: 8px 12px;
         font-size: 0.85rem;
       }
       
       .submit-btn {
         padding: 12px 18px;
         font-size: 0.9rem;
       }
       
       .result-section {
         padding: 15px;
         margin-top: 15px;
       }
       
       .result-title {
         font-size: 1.2rem;
       }
       
       .bazi-info {
         gap: 15px;
       }
       
       .basic-info {
         grid-template-columns: repeat(2, 1fr);
         gap: 12px;
       }
       
       .info-item {
         padding: 10px;
       }
       
       .info-label {
         font-size: 0.75rem;
       }
       
       .info-value {
         font-size: 0.85rem;
       }
       
       .pillars-grid {
         grid-template-columns: repeat(2, 1fr);
         gap: 12px;
       }
       
       .pillar-card {
         padding: 12px;
       }
       
       .pillar-header {
         font-size: 0.8rem;
         margin-bottom: 8px;
       }
       
       .pillar-main {
         font-size: 1.2rem;
         margin-bottom: 8px;
       }
       
       .pillar-details {
         gap: 6px;
       }
       
       .detail-row {
         gap: 6px;
       }
       
       .detail-label {
         font-size: 0.7rem;
       }
       
       .detail-value {
         font-size: 0.8rem;
       }
       
       .dayun-content {
         grid-template-columns: 1fr;
         gap: 12px;
       }
       
       .dayun-item {
         padding: 8px;
       }
       
       .dayun-label {
         font-size: 0.75rem;
       }
       
       .dayun-value {
         font-size: 0.8rem;
       }
       
       .action-buttons {
         flex-direction: column;
         gap: 10px;
       }
       
       .action-btn {
         padding: 10px 14px;
         font-size: 0.85rem;
       }
     }

     @media (max-width: 480px) {
       body {
         background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
         padding: 0;
         margin: 0;
       }
       
       body::before {
         display: block;
       }
       
       .container {
         background: rgba(26, 26, 46, 0.9);
         backdrop-filter: blur(20px);
         box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
         border: 1px solid rgba(255, 255, 255, 0.1);
         padding: 12px;
         margin: 12px;
         width: calc(100% - 24px);
         max-width: none;
       }
       
       .header {
         margin-bottom: 20px;
       }
       
       .logo {
         font-size: 2rem;
       }
       
       .title {
         font-size: 1.3rem;
       }
       
       .subtitle {
         font-size: 0.8rem;
       }
       
       .form-group {
         margin-bottom: 15px;
       }
       
       .form-label {
         font-size: 0.75rem;
       }
       
       .form-input, .form-select {
         padding: 8px 12px;
         font-size: 0.8rem;
       }
       
       .gender-group {
         gap: 8px;
       }
       
       .gender-label {
         padding: 6px 10px;
         font-size: 0.8rem;
       }
       
       .submit-btn {
         padding: 10px 16px;
         font-size: 0.85rem;
       }
       
       .result-section {
         padding: 12px;
         margin-top: 12px;
       }
       
       .result-title {
         font-size: 1.1rem;
       }
       
       .bazi-info {
         gap: 12px;
       }
       
       .basic-info {
         grid-template-columns: 1fr;
         gap: 10px;
       }
       
       .info-item {
         padding: 8px;
       }
       
       .info-label {
         font-size: 0.7rem;
       }
       
       .info-value {
         font-size: 0.8rem;
       }
       
       .pillars-grid {
         grid-template-columns: 1fr;
         gap: 10px;
       }
       
       .pillar-card {
         padding: 10px;
       }
       
       .pillar-header {
         font-size: 0.75rem;
         margin-bottom: 6px;
       }
       
       .pillar-main {
         font-size: 1.1rem;
         margin-bottom: 6px;
       }
       
       .pillar-details {
         gap: 4px;
       }
       
       .detail-row {
         gap: 4px;
       }
       
       .detail-label {
         font-size: 0.65rem;
       }
       
       .detail-value {
         font-size: 0.75rem;
       }
       
       .dayun-content {
         grid-template-columns: 1fr;
         gap: 10px;
       }
       
       .dayun-item {
         padding: 6px;
       }
       
       .dayun-label {
         font-size: 0.7rem;
       }
       
       .dayun-value {
         font-size: 0.75rem;
       }
       
       .action-buttons {
         flex-direction: column;
         gap: 8px;
       }
       
       .action-btn {
         padding: 8px 12px;
         font-size: 0.8rem;
       }
     }
  </style>
  <script>
    // These will be filled by the server in the HTML response
    let countryToTimezones = {};
    let countryNames = {};
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">â˜¯ï¸</div>
      <h1 class="title">å…«å­—å‘½ç†</h1>
      <p class="subtitle">æ¢ç´¢ä½ çš„äººç”Ÿå¯†ç ï¼Œå‘ç°å†…åœ¨æ½œèƒ½</p>
    </div>

  <form id="birthForm" action="/convert" method="post">
      <div class="form-group">
        <label class="form-label" for="country">
          <i class="fas fa-globe"></i>
          å›½å®¶ / Country
        </label>
        <select name="country" id="country" class="form-select" required>
          <option value="">è¯·é€‰æ‹©å›½å®¶</option>
      </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="state">
          <i class="fas fa-map-marker-alt"></i>
          çœä»½ / State
        </label>
        <select name="state" id="state" class="form-select" required disabled>
          <option value="">è¯·å…ˆé€‰æ‹©å›½å®¶</option>
      </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="city">
          <i class="fas fa-city"></i>
          åŸå¸‚ / City
        </label>
        <select name="city" id="city" class="form-select" required disabled>
          <option value="">è¯·å…ˆé€‰æ‹©çœä»½</option>
      </select>
      </div>

      <div class="form-group">
        <label class="form-label">
          <i class="fas fa-venus-mars"></i>
          æ€§åˆ« / Gender
        </label>
        <div class="gender-group">
          <div class="gender-option">
            <input type="radio" id="female" class="gender-radio" value="0" name="gender" required>
            <label for="female" class="gender-label">
              <i class="fas fa-venus"></i>
              å¥³æ€§
            </label>
          </div>
          <div class="gender-option">
            <input type="radio" id="male" class="gender-radio" value="1" name="gender" required>
            <label for="male" class="gender-label">
              <i class="fas fa-mars"></i>
              ç”·æ€§
            </label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="birthdate">
          <i class="fas fa-calendar-alt"></i>
          å‡ºç”Ÿæ—¥æœŸ / Birth Date
        </label>
        <input type="date" id="birthdate" name="birthdate" class="form-input" required>
      </div>

      <div class="form-group">
        <label class="form-label" for="time">
          <i class="fas fa-clock"></i>
          å‡ºç”Ÿæ—¶é—´ / Birth Time
        </label>
        <input type="time" id="time" name="time" class="form-input" required>
      </div>

      <button type="submit" class="submit-btn">
        <i class="fas fa-magic"></i>
        å¼€å§‹æ¢ç´¢å‘½ç†
      </button>
  </form>

    <div id="baziResult" class="result-section">
      <h3 class="result-title">
        <i class="fas fa-yin-yang"></i>
        ä½ çš„å…«å­—ä¿¡æ¯
      </h3>
      <div id="resultContent" class="result-content"></div>
      <div class="action-buttons">
        <a href="chat.html" class="action-btn btn-chat" id="chatLink" style="display:none;">
          <i class="fas fa-comments"></i>
          AI å‘½ç†å’¨è¯¢
        </a>
        <button class="action-btn btn-report" id="reportLink" style="display:none;" onclick="generateReport()">
          <i class="fas fa-file-alt"></i>
          ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
        </button>
        <button class="action-btn btn-edit" id="editLink" style="display:none;" onclick="showForm()">
          <i class="fas fa-edit"></i>
          é‡æ–°å¡«å†™ä¿¡æ¯
        </button>
        <button class="action-btn btn-report2" id="report2Link" style="display:none;" onclick="generateReport2()">
          <i class="fas fa-star"></i>
          æ˜Ÿç©ºç‰ˆæŠ¥å‘Š
        </button>
      </div>
    </div>
  </div>

  <script>
    async function generateReport() {
      // æ£€æŸ¥æ˜¯å¦å·²ç»ç”Ÿæˆäº†å…«å­—æ•°æ®
      if (!localStorage.getItem('baziData') && (!document.getElementById('baziResult') || !document.getElementById('baziResult').classList.contains('show'))) {
        alert('âŒ è¯·å…ˆå¡«å†™ç”Ÿæ—¥ä¿¡æ¯\n\nğŸ“ æ‚¨éœ€è¦å…ˆå¡«å†™å®Œæ•´çš„ç”Ÿæ—¥ä¿¡æ¯ï¼ˆå¹´æœˆæ—¥æ—¶é—´ã€æ€§åˆ«ã€å‡ºç”Ÿåœ°ç‚¹ï¼‰ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æ¢ç´¢å‘½ç†"æŒ‰é’®ç”Ÿæˆå…«å­—æ•°æ®ï¼Œä¹‹åæ‰èƒ½ç”ŸæˆæŠ¥å‘Šã€‚\n\nğŸ‘† è¯·å…ˆå®Œæˆä¸Šæ–¹çš„è¡¨å•å¡«å†™');
        return;
      }
      
      const reportBtn = document.getElementById('reportLink');
      const originalText = reportBtn.innerHTML;
      
      try {
        reportBtn.innerHTML = '<div class="loading"><div class="spinner"></div>ç”Ÿæˆä¸­...</div>';
        reportBtn.disabled = true;
        
        const response = await fetch('/generate-report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          if (response.status === 400) {
            // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
            alert(`âŒ ${errorData.error}\n\nğŸ“ ${errorData.message}\n\nğŸ‘† ${errorData.action}`);
            return;
          }
          throw new Error(errorData.error || 'ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
        }
        
        window.location.href = 'report.html';
        
      } catch (err) {
        const resultDiv = document.getElementById('resultContent');
        resultDiv.innerHTML += `<div class="error">ç”ŸæˆæŠ¥å‘Šæ—¶å‡ºé”™: ${err.message}</div>`;
        reportBtn.innerHTML = originalText;
        reportBtn.disabled = false;
      }
    }

    async function generateReport2() {
      // æ£€æŸ¥æ˜¯å¦å·²ç»ç”Ÿæˆäº†å…«å­—æ•°æ®
      if (!localStorage.getItem('baziData') && (!document.getElementById('baziResult') || !document.getElementById('baziResult').classList.contains('show'))) {
        alert('âŒ è¯·å…ˆå¡«å†™ç”Ÿæ—¥ä¿¡æ¯\n\nğŸ“ æ‚¨éœ€è¦å…ˆå¡«å†™å®Œæ•´çš„ç”Ÿæ—¥ä¿¡æ¯ï¼ˆå¹´æœˆæ—¥æ—¶é—´ã€æ€§åˆ«ã€å‡ºç”Ÿåœ°ç‚¹ï¼‰ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æ¢ç´¢å‘½ç†"æŒ‰é’®ç”Ÿæˆå…«å­—æ•°æ®ï¼Œä¹‹åæ‰èƒ½ç”ŸæˆæŠ¥å‘Šã€‚\n\nğŸ‘† è¯·å…ˆå®Œæˆä¸Šæ–¹çš„è¡¨å•å¡«å†™');
        return;
      }
      
      const report2Btn = document.getElementById('report2Link');
      const originalText = report2Btn.innerHTML;
      
      try {
        report2Btn.innerHTML = '<div class="loading"><div class="spinner"></div>ç”Ÿæˆä¸­...</div>';
        report2Btn.disabled = true;
        
        const response = await fetch('/generate-report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          if (response.status === 400) {
            // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
            alert(`âŒ ${errorData.error}\n\nğŸ“ ${errorData.message}\n\nğŸ‘† ${errorData.action}`);
            return;
          }
          throw new Error(errorData.error || 'ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
        }
        
        window.location.href = 'report2.html';
        
      } catch (err) {
        const resultDiv = document.getElementById('resultContent');
        resultDiv.innerHTML += `<div class="error">ç”ŸæˆæŠ¥å‘Šæ—¶å‡ºé”™: ${err.message}</div>`;
        report2Btn.innerHTML = originalText;
        report2Btn.disabled = false;
      }
    }

    // è·å–äº”è¡Œå¯¹åº”çš„CSSç±»å
    function getElementClass(element) {
      const elementMap = {
        'æœ¨': 'element-wood',
        'ç«': 'element-fire', 
        'åœŸ': 'element-earth',
        'é‡‘': 'element-metal',
        'æ°´': 'element-water'
      };
      return elementMap[element] || '';
    }

    // ä»localStorageåŠ è½½å…«å­—æ•°æ®
    function loadBaziDataFromStorage() {
      const savedData = localStorage.getItem('baziData');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          displayBaziData(data);
          return true;
        } catch (error) {
          console.error('åŠ è½½ä¿å­˜çš„å…«å­—æ•°æ®å¤±è´¥:', error);
          localStorage.removeItem('baziData');
        }
      }
      return false;
    }

    // ä¿å­˜å…«å­—æ•°æ®åˆ°localStorage
    function saveBaziDataToStorage(data) {
      try {
        localStorage.setItem('baziData', JSON.stringify(data));
      } catch (error) {
        console.error('ä¿å­˜å…«å­—æ•°æ®å¤±è´¥:', error);
      }
    }

    // éšè—è¡¨å•
    function hideForm() {
      const form = document.getElementById('birthForm');
      const header = document.querySelector('.header');
      if (form) form.style.display = 'none';
      if (header) header.style.display = 'none';
    }

    // æ˜¾ç¤ºè¡¨å•
    function showForm() {
      const form = document.getElementById('birthForm');
      const header = document.querySelector('.header');
      const baziResult = document.getElementById('baziResult');
      const editLink = document.getElementById('editLink');
      const report2Link = document.getElementById('report2Link');
      
      if (form) form.style.display = 'block';
      if (header) header.style.display = 'block';
      if (baziResult) baziResult.classList.remove('show');
      if (editLink) editLink.style.display = 'none';
      if (report2Link) report2Link.style.display = 'none';
      
      // æ¸…é™¤localStorageæ•°æ®
      localStorage.removeItem('baziData');
      
      // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
      window.scrollTo(0, 0);
    }

    // æ˜¾ç¤ºå…«å­—æ•°æ®
    function displayBaziData(result) {
      const baziResultDiv = document.getElementById('baziResult');
      const resultContent = document.getElementById('resultContent');
      
      let html = '';
      
      if (result.baziData && Object.keys(result.baziData).length > 0) {
        const bazi = result.baziData;
        
        // åŸºæœ¬ä¿¡æ¯
        html += `
          <div class="basic-info">
            <div class="info-item">
              <div class="info-label">æ—¶åŒº</div>
              <div class="info-value">${result.timezone}</div>
            </div>
            <div class="info-item">
              <div class="info-label">æ€§åˆ«</div>
              <div class="info-value">${result.gender}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ç”Ÿè‚–</div>
              <div class="info-value">${bazi.ç”Ÿè‚– || 'æœªçŸ¥'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">é˜³å†</div>
              <div class="info-value">${bazi.é˜³å† || 'æœªçŸ¥'}</div>
            </div>
          </div>
        `;
        
        // å››æŸ±å…«å­—
        html += `
          <div class="pillars-section">
            <div class="pillars-title">
              <i class="fas fa-yin-yang"></i>
              å››æŸ±å…«å­—
            </div>
            <div class="pillars-grid">
        `;
        
        const pillars = [
          { name: 'å¹´æŸ±', data: bazi.å¹´æŸ±, chars: bazi.å…«å­—?.split(' ')[0] || '' },
          { name: 'æœˆæŸ±', data: bazi.æœˆæŸ±, chars: bazi.å…«å­—?.split(' ')[1] || '' },
          { name: 'æ—¥æŸ±', data: bazi.æ—¥æŸ±, chars: bazi.å…«å­—?.split(' ')[2] || '' },
          { name: 'æ—¶æŸ±', data: bazi.æ—¶æŸ±, chars: bazi.å…«å­—?.split(' ')[3] || '' }
        ];
        
        pillars.forEach(pillar => {
          if (pillar.data) {
            const tianganElement = getElementClass(pillar.data.å¤©å¹²?.äº”è¡Œ);
            const dizhiElement = getElementClass(pillar.data.åœ°æ”¯?.äº”è¡Œ);
            const tenshen = pillar.data.å¤©å¹²?.åç¥;
            
            html += `
              <div class="pillar-card">
                <div class="pillar-header">${pillar.name}</div>
                <div class="pillar-main">${pillar.chars}</div>
                <div class="pillar-details">
                  <div class="detail-row">
                    <span class="detail-label">å¤©å¹²:</span>
                    <span class="detail-value ${tianganElement}">${pillar.data.å¤©å¹²?.å¤©å¹² || ''}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">äº”è¡Œ:</span>
                    <span class="detail-value ${tianganElement}">${pillar.data.å¤©å¹²?.äº”è¡Œ || ''}</span>
                  </div>
                  ${tenshen ? `
                  <div class="detail-row">
                    <span class="detail-label">åç¥:</span>
                    <span class="detail-value tenshen">${tenshen}</span>
                  </div>
                  ` : ''}
                  <div class="detail-row">
                    <span class="detail-label">åœ°æ”¯:</span>
                    <span class="detail-value ${dizhiElement}">${pillar.data.åœ°æ”¯?.åœ°æ”¯ || ''}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">äº”è¡Œ:</span>
                    <span class="detail-value ${dizhiElement}">${pillar.data.åœ°æ”¯?.äº”è¡Œ || ''}</span>
                  </div>
                </div>
              </div>
            `;
          }
        });
        
        html += `
            </div>
          </div>
        `;
        
        // å½“å‰å¤§è¿
        if (bazi.å¤§è¿?.å¤§è¿?.length > 0) {
          const currentYear = new Date().getFullYear();
          let currentDayun = null;
          
          for (let dayun of bazi.å¤§è¿.å¤§è¿) {
            if (dayun.å¼€å§‹å¹´ä»½ <= currentYear && dayun.ç»“æŸå¹´ä»½ >= currentYear) {
              currentDayun = dayun;
              break;
            }
          }
          
          if (currentDayun) {
            html += `
              <div class="dayun-section">
                <div class="dayun-title">
                  â­ å½“å‰å¤§è¿ (${currentDayun.å¼€å§‹å¹´ä»½}-${currentDayun.ç»“æŸå¹´ä»½})
                </div>
                <div class="dayun-content">
                  <div class="dayun-item">
                    <div class="dayun-label">å¤©å¹²åç¥</div>
                    <div class="dayun-value">${currentDayun.å¤©å¹²åç¥ || 'æœªçŸ¥'}</div>
                  </div>
                  <div class="dayun-item">
                    <div class="dayun-label">åœ°æ”¯åç¥</div>
                    <div class="dayun-value">${Array.isArray(currentDayun.åœ°æ”¯åç¥) ? currentDayun.åœ°æ”¯åç¥.join(', ') : (currentDayun.åœ°æ”¯åç¥ || 'æœªçŸ¥')}</div>
                  </div>
                </div>
              </div>
            `;
          }
        }
        
      } else {
        html += '<div class="error">æœªèƒ½è·å–å…«å­—æ•°æ®</div>';
      }
      
      resultContent.innerHTML = html;
      baziResultDiv.classList.add('show');
      document.getElementById('chatLink').style.display = '';
      document.getElementById('reportLink').style.display = '';
      document.getElementById('editLink').style.display = '';
      document.getElementById('report2Link').style.display = '';
    }

    // Handle form submission
    document.addEventListener('DOMContentLoaded', function() {
          // é¡µé¢åŠ è½½æ—¶å°è¯•ä»localStorageæ¢å¤å…«å­—æ•°æ®
    const hasData = loadBaziDataFromStorage();
    if (hasData) {
      // å¦‚æœæœ‰ä¿å­˜çš„æ•°æ®ï¼Œéšè—è¡¨å•å¹¶æ˜¾ç¤ºæ‰€æœ‰æŒ‰é’®
      hideForm();
      document.getElementById('chatLink').style.display = '';
      document.getElementById('reportLink').style.display = '';
      document.getElementById('editLink').style.display = '';
      document.getElementById('report2Link').style.display = '';
    }
      
      document.getElementById('birthForm').onsubmit = async function(e) {
        e.preventDefault();
        
        // æ¸…é™¤æ—§çš„localStorageæ•°æ®
        localStorage.removeItem('baziData');
        
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        const submitBtn = document.querySelector('.submit-btn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading"><div class="spinner"></div>è®¡ç®—ä¸­...</div>';
        submitBtn.disabled = true;
        
        try {
        const resp = await fetch('/convert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
          
        const baziResultDiv = document.getElementById('baziResult');
          const resultContent = document.getElementById('resultContent');
          
        if (resp.ok) {
          const result = await resp.json();
          
          // ä¿å­˜å…«å­—æ•°æ®åˆ°localStorage
          saveBaziDataToStorage(result);
          
          // æ˜¾ç¤ºå…«å­—æ•°æ®
          displayBaziData(result);
          
          // éšè—è¡¨å•
          hideForm();

        } else {
          const err = await resp.text();
            resultContent.innerHTML = `<div class="error">é”™è¯¯: ${err}</div>`;
            baziResultDiv.classList.add('show');
          }
        } catch (error) {
          const resultContent = document.getElementById('resultContent');
          resultContent.innerHTML = `<div class="error">è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
          document.getElementById('baziResult').classList.add('show');
        } finally {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      };
    });
  </script>

  <script>
    // This script will be replaced by the server to inject country/timezone data and populate the dropdowns
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const countrySelect = document.getElementById('country');
      const stateSelect = document.getElementById('state');
      const citySelect = document.getElementById('city');

      // Handle country selection
      countrySelect.addEventListener('change', function() {
        const countryCode = this.value;
        stateSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å›½å®¶</option>';
        citySelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©çœä»½</option>';
        stateSelect.disabled = true;
        citySelect.disabled = true;
        
        if (countryCode) {
          fetch(`/states/${countryCode}`)
            .then(res => res.json())
            .then(states => {
              stateSelect.innerHTML = '<option value="">è¯·é€‰æ‹©çœä»½</option>';
              states.forEach(state => {
                const opt = document.createElement('option');
                opt.value = state.isoCode;
                opt.textContent = state.name;
                stateSelect.appendChild(opt);
              });
              stateSelect.disabled = false;
            })
            .catch(error => {
              console.error('è·å–çœä»½æ•°æ®å¤±è´¥:', error);
            });
        }
      });

      // Handle state selection
      stateSelect.addEventListener('change', function() {
        const countryCode = countrySelect.value;
        const stateCode = this.value;
        citySelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©çœä»½</option>';
        citySelect.disabled = true;
        
        if (countryCode && stateCode) {
          fetch(`/cities/${countryCode}/${stateCode}`)
            .then(res => res.json())
            .then(cities => {
                if (cities.length > 0) {
                citySelect.innerHTML = '<option value="">è¯·é€‰æ‹©åŸå¸‚</option>';
                  cities.forEach(city => {
                    const opt = document.createElement('option');
                    opt.value = city.name;
                    opt.textContent = city.name;
                    citySelect.appendChild(opt);
                  });
                  citySelect.disabled = false;
                  citySelect.required = true;
                } else {
                citySelect.innerHTML = '<option value="æ— åŸå¸‚æ•°æ®">è¯¥çœä»½æš‚æ— åŸå¸‚æ•°æ®</option>';
                  citySelect.disabled = false;
                citySelect.required = false;
                }
            })
            .catch(error => {
              console.error('è·å–åŸå¸‚æ•°æ®å¤±è´¥:', error);
              citySelect.innerHTML = '<option value="åŠ è½½å¤±è´¥">åŸå¸‚æ•°æ®åŠ è½½å¤±è´¥</option>';
              citySelect.disabled = false;
              citySelect.required = false;
            });
        }
      });
    });
  </script>
</body>
</html>
</html>